<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Cocina - Pedido en Curso</title>
    <style>
        table { border-collapse: collapse; width: 80%; margin: 20px auto; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .preparing { background-color: #fff3cd; }  /* amarillo */
        .ready { background-color: #d4edda; }      /* verde */
        .waiting { text-align: center; font-style: italic; }
    </style>
</head>
<body>
    <h1 style="text-align:center;">Cocina - Pedido en Curso üçΩÔ∏è</h1>
    <p style="text-align:center;">Estado de conexi√≥n: <span id="status">Desconectado</span></p>

    <table id="ordersTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Mesa</th>
                <th>Items</th>
                <th>Estado</th>
                <th>Tiempo Estimado (s)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const statusEl = document.getElementById("status");
        const tableBody = document.querySelector("#ordersTable tbody");
        let currentOrder = null; // solo un pedido a la vez

        const ws = new WebSocket("ws://localhost:4000");

        ws.onopen = () => {
            statusEl.textContent = "Conectado";
            console.log("Conectado al WebSocket");
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("Mensaje recibido:", msg);

            if (msg.type === "ORDER_NEW") {
                currentOrder = { ...msg.order, status: "preparing" };
                renderTable();
            }

            if (msg.type === "ORDER_READY") {
                if (currentOrder && currentOrder.id === msg.id) {
                    currentOrder.status = "ready";
                    renderTable();
                }
            }

            if (msg.type === "QUEUE_EMPTY") {
                currentOrder = null; // no hay pedidos en cola
                renderTable();
            }
        };

        function renderTable() {
            tableBody.innerHTML = "";

            if (!currentOrder) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="6" class="waiting">üïí Esperando nuevos pedidos...</td>`;
                tableBody.appendChild(tr);
                return;
            }

            const items = currentOrder.items.map(i => `${i.productName} x${i.quantity}`).join(", ");
            const totalTime = currentOrder.items.reduce((sum, i) => {
                let t = 0;
                const name = i.productName.toLowerCase();
                if (name.includes("hamburguesa")) t = 10;
                else if (name.includes("papa")) t = 4;
                else if (name.includes("perro")) t = 6;
                else if (name.includes("refresc") || name.includes("limonada")) t = 2;
                return sum + t * i.quantity;
            }, 0);

            const tr = document.createElement("tr");
            tr.className = currentOrder.status === "preparing" ? "preparing" : "ready";

            tr.innerHTML = `
                <td>${currentOrder.id}</td>
                <td>${currentOrder.customerName}</td>
                <td>${currentOrder.table}</td>
                <td>${items}</td>
                <td>${currentOrder.status}</td>
                <td>${totalTime}</td>
            `;
            tableBody.appendChild(tr);
        }

        ws.onclose = () => {
            statusEl.textContent = "Desconectado";
            console.log("WebSocket cerrado");
        };

        ws.onerror = (err) => {
            console.error("Error en WebSocket:", err);
        };
    </script>
</body>
</html>
